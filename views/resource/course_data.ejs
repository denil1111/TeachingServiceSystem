<!doctype html>
<html>
<head>
    <% include ../head.html %>
    <script type="text/javascript" src="/javascripts/vendor/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/javascripts/vendor/jquery.tmpl.js"></script>
    <script type="text/javascript" src="/javascripts/vendor/ajaxfileupload.js"></script>
    <link rel="stylesheet" type="text/css" href="/stylesheets/easyui.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/icon.css">
    <style>
        .action-nav-button{
            width: 15%;
        }
        #chosen-add-button{
            display:none;
        }
        .table-normal tbody td{
            padding:8px;
        }
    </style>

    <script>
        function downloadByUrl(fid,_name){
//                window.open("/resource/cloud/iddownload/"+fid);
            $.post(
                    "/resource/cloud/iddownload",
                    {
                        fid:fid,
                        name:_name
                    },
                    function(_data){
                        //TODO: maybe can ...
                        window.open("/resource/cloud/iddownload/" + fid);
                    }
            ).error(function(){
                        alert("超级下载出错！");
                    });
        }

        function formSize(_size){
            if(_size){
                var n = Math.floor(Math.log(_size)/Math.log(1024));
                switch (n){
                    case 0:return Math.floor(_size)+"B";break;
                    case 1:return Math.floor(_size/1024)+"KB";break;
                    case 2:return Math.floor(_size/1024/1024)+"MB";break;
                    case 3:return Math.floor(_size/1024/1024/1024)+"GB";break;
                    case 4:return "WQNMLGB";break;
                    default:break;
                }
            }else{
                return "";
            }

        }

        //jquery 1.6以后
        function chooseAll(){
            //            console.log("in chooseAll");
            var isChecked=$("#all-choose").prop("checked");
            if(isChecked==false)
            {
                $("input[name=choose]").prop("checked",false);
            }
            else
            {
                $("input[name=choose]").prop("checked",true);
            }
//                $("#chosen-add-button").show();
        };

        $(document).ready(function(){
            $("input[name=choose]").click(function(){
                var flag=false;
                $("input[name=choose]").each(function(){
                    if($(this).prop("checked")==true)
                    {
                        flag=true;
                        $("#chosen-add-button").show();
                        return false;
                    }
                });
                if(flag!=true)
                {
                    $("#chosen-add-button").hide();
                }
            });
        });

    </script>

</head>
<body>
<!-- 上方选择条 navbar-top-->
<% include ../navbar.html %>
<!-- 侧边框 -->
<% include slide_course.html%>



<!-- 主要内容 -->
<div class="main-content">
    <%include current_title.html %>
    <%include resource_bar.html%>

    <%var root = false %>

    <div class="span10" style="">
        <div class="row">
            <div class="span10">
                <div class="box">
                    <div class="box-header">
                        <span class="title">课程资源</span>
                        <ul class="box-toolbar">
                            <li>
                            <button class="btn btn-xs btn-default" data-view="backFolder">
                                <i class="icon-reply"></i>
                                <span>返回上级</span>
                            </button>
                            </li>
                            <li style="margin-left:0px;">
                                <button class="btn btn-xs btn-success"  data-toggle="modal" href="#modal-share">
                                    <i class="icon-share"></i>
                                    <span>分享资源</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="box-content" >
                        <%if (root == true){%>
                        <div style="padding: 15px 15px;border-bottom:1px solid #d1d2da;"><i class="icon-info-sign"></i>直接拖拽可以改变资源顺序</div>
                        <%}%>
                        <table class="table table-normal">
                            <thead>
                            <tr>
                                <td></td>
                                <td style="width:50px;"><input type="checkbox" id="all-choose" name="choose" onclick="chooseAll()" style="text-align:center;"></td>
                                <td>资源名称</td>
                                <td style="width:60px">资源类型</td>
                                <td style="width:60px">资源大小</td>
                                <td style="width:100px">分享人</td>
                                <td style="width:120px"></td>
                            </tr>
                            </thead>

                            <tbody id="fileList">

                            </tbody>
                        </table>
                        <div id="chosen-add-button">
                            <button class="btn btn-xs btn-default" style="margin-left: 20px;margin-top: 20px;margin-bottom:20px;">删除</button>
                            <button class="btn btn-xs btn-default" style="margin-left: 10px;margin-top: 20px;margin-bottom:20px;">下载</button>
                        </div>
                    </div>
                </div>

                <div id="modal-share" class="modal fade hide">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title">分享资源</h4>
                            </div>
                            <div class="modal-body">
                                <label>请选择想要分享的文件</label>
                                <ul id="moveTree" class="easyui-tree"></ul>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">放弃</button>
                                <button type="button" class="btn btn-blue" data-src="" id="shareSubmit">确定</button>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal-dialog -->
                </div><!-- /.modal --><!-- find me in partials/modal_form -->
            </div>

            <!--TODO:权限删除-->
            <script id="fileListTpl" type="text/x-jquery-tmpl">
                <tr>
                    <td class="icon"><i class="{{if isFolder}} icon-folder-close {{else}} icon-file {{/if}}"></i></td>
                    <td style="width:50px;text-align:center;"><input type="checkbox" name="choose"></td>
                    <td><a href="{{if isFolder}}javascript:void(0){{else}}#{{/if}}" {{if isFolder}} data-view="enterFolder" name="${text}" {{/if}}>${text}</a></td>
                    <td style="width:60px;"><b>${ext}</b></td>
                    <td style="width:60px;"><b>${formsize}</b></td>
                    <td style="width:100px;"><b>${courseName}</b></td>
                    <td style="width:120px;">
                        <div class="btn-group">
                            <button class="btn btn-xs btn-default" data-src="${text}" func="delete-btn"><i class="icon-remove-sign"></i> 删除</button>
                            {{if !isFolder}}<button class="btn btn-xs btn-blue" func="download-btn" onclick="downloadByUrl('${fid}','${text}')"><i class="icon-download-alt"></i>下载</button>{{/if}}
                        </div>
                    </td>
                </tr>
            </script>

            <script>
                ;(function($){
                    var _fileMap=<%-JSON.stringify(fileTree)%>;
                    var _resourceMap=<%-JSON.stringify(cfileTree)%>;
                    var _nowUrl="";
                    var _nowDir=findDirByUrl(_nowUrl);
                    $("#moveTree").tree({
                        data:_fileMap
                    });

                    //显示文件列表
                    function findDirByUrl(_url){
                        var _urlArray=_url.split(".");
                        var _dir=_resourceMap.slice(0);
                        console.log(_urlArray);
                        if(_urlArray.length==0){
                            return _dir;
                        }
                        else{
                            for(var i=0; i<_urlArray.length;i++){
                                for(var j=0; j<_dir.length;j++){
                                    if(_dir[j]["text"]==_urlArray[i]){
                                        _dir=_dir[j]["children"];
                                        break;
                                    }
                                }
                            }
                            return _dir;
                        }
                    }

                    function showFileList(_nowDir){
                        $("#moveTree").tree({
                            //TODO:这里应该是自己的云盘的fileMap
                            data:_fileMap
                        });
                        $("#fileList").empty();
                        for(var i=0;i<_nowDir.length;i++){
                            _nowDir[i].order=i;
                            _nowDir[i].formsize=formSize(_nowDir[i].size);
                            $("#fileListTpl").tmpl(_nowDir[i]).appendTo("#fileList");
                        }
                    };

                    function refreshFileList(_newFileMap){
                        $('#moveTree').tree('loadData', _fileMap);
                        _resourceMap= _newFileMap;
                        _nowDir=findDirByUrl(_nowUrl);
                        showFileList(_nowDir);
                    }

                    showFileList(_nowDir);

                    //返回上一级
                    $(".box-toolbar").delegate("[data-view=backFolder]","click",function(_event){
                        var _nowUrlArray=_nowUrl.split(".");
                        _nowUrlArray.pop();
                        _nowUrl=_nowUrlArray.join(".");
                        _nowDir=findDirByUrl(_nowUrl);
                        showFileList(_nowDir);
                    })

                    //进入文件夹
                    $("#fileList").delegate("[data-view=enterFolder]","click",function(_event){
                        _event.preventDefault();
                        var _name=_event.target.getAttribute("name");
                        _nowUrl=_nowUrl?_nowUrl.concat(".",_name):_name;
                        console.log(_nowUrl);
                        _nowDir=findDirByUrl(_nowUrl);
                        showFileList(_nowDir);
                    })

                    //删除文件或文件夹接口 url,name 返回code,newTree
                    $("#fileList").delegate("[func=delete-btn]","click",function(_e){
                        var choice=confirm("您确定要删除这个资源么？");
                        if(choice){
                            console.log("in delete");
                            var _name = _e.target.getAttribute("data-src");
                            console.log(_nowUrl);
                            console.log(_name);
                            $.post(
                                    "/resource/cloud/deletenode",
                                    {
                                        url:_nowUrl,
                                        name:_name
                                    },
                                    function(_data){
                                        if(_data.code==200){
                                            alert("删除成功");
                                            refreshFileList(_data.newTree);
                                        }else{
                                            alert("删除失败");
                                        }
                                    }
                            ).error(function(){
                                        alert("请求失败");
                                    });
                        }else{
                            return;
                        }
                    });

                    //分享资源接口 url
                    $("#shareSubmit").bind("click",function(_e){
                        var _node = $("#moveTree").tree("getSelected");
                        var _urlArray=[];
                        //TODO:判断文件夹还不能是子文件夹
                        if(!_node){
                            alert("请选择文件!");
                            return;
                        }else{
                            var _parent = $("#moveTree").tree("getParent",_node.target);
                            while(_parent){
                                _urlArray.push(_node.text);
                                _node=$("#moveTree").tree("getParent",_node.target);
                                _parent=$("#moveTree").tree("getParent",_node.target);
                            }
                            _urlArray.push(_node.text);
                            var _newUrl="";
                            for(var i = _urlArray.length-1 ; i>=0 ; i--){
                                _newUrl=_newUrl?_newUrl.concat("."+_urlArray[i]):_urlArray[i];
                            }
                            console.log(_newUrl);
                            $.post(
                                    "/resource/course/newfile",
                                    {
                                        fromUrl:_newUrl,
                                        toUrl:_nowUrl
                                    },
                                    function(_data){
                                        if(_data.code==200){
                                            alert("操作成功");
                                            refreshFileList(_data.newTree);
                                        }else{
                                            alert("操作失败");
                                        }
                                    }
                            ).error(function(){
                                        alert("请求失败");
                                    });
                        }
                    });

                    <%if (root == true){%>
                        $("#fileList").sortable();
                    <%}%>


                })(jQuery)


            </script>
</body>
</html>